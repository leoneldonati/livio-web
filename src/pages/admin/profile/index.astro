---
import { IconCalendarPlus, IconMapPin } from "@tabler/icons-react";
import BackBtn from "~/components/back-btn.astro";
import PostCard from "~/components/client/post-card";
import RootLayout from "~/layouts/RootLayout.astro";
import { getSessionValue } from "~/scripts/session";
import ApiServices from "~/services/api";
import type { Post, User } from "~/types";
const id = getSessionValue(Astro);
if (id == null) return Astro.redirect("/login");

const { getUserById, getPostsByUserid } = new ApiServices(Astro.url.origin);

const { response: user } = (await getUserById(id)) as { response: User };
const { response: posts } = (await getPostsByUserid(id)) as {
  response: Post[];
};
---

<RootLayout title=`@${user?.username} - Perfil.`>
  <section class="admin-profile">
    <!-- ENCABEZADO SUPERIOR -->
    <header>
      <BackBtn />

      <div>
        <strong class="admin-profile__name">
          {user?.name}
        </strong>
        <small>
          {posts?.length} publicaciones
        </small>
      </div>
    </header>

    <!-- FOTO DE PORTADA -->
    <picture class="admin-profile__header-photo">
      {
        user?.headerPhoto && (
          <img
            src={user?.headerPhoto.secureUrl}
            alt={`Foto de portada de @${user?.username}`}
          />
        )
      }
    </picture>

    <div class="admin-profile__container--bottom">
      <!-- AVATAR -->
      <picture class="admin-profile__avatar">
        {
          user?.avatar && (
            <img
              src={user?.avatar.secureUrl}
              alt={`Avatar de @${user?.username}`}
            />
          )
        }
      </picture>

      <!-- NOMBRE Y NOMBRE DE USUARIO -->
      <div class="admin-profile__container--names">
        <h1>
          {user?.name}
        </h1>
        <small>
          @{user?.username}
        </small>
      </div>

      <!-- BIO -->
      <p class="admin-profile__bio">
        {user?.bio}
      </p>

      <!-- OTRA INFORMACIÓN -->
      <div class="admin-profile__container--other-info">
        <span>
          <IconMapPin />
          {user?.location?.country ? user.location.country : "Sin ubicación"}
        </span>

        <span>
          <IconCalendarPlus /> Te uniste: {}
        </span>
      </div>

      <!-- SEGUIDORES -->
      <div class="admin-profile__container--followers">
        <div>
          <span>
            <strong>
              {user?.followed.length}
            </strong>
            Siguiendo
          </span>

          <span>
            <strong>
              {user?.followers.length}
            </strong>
            Seguidores
          </span>
        </div>

        <!-- BOTÓN -->
        <a
          href="/admin/profile/edit"
          title="Edita tu perfil."
          class="admin-profile__edit-btn"
        >
          Editar perfil
        </a>
      </div>
    </div>

    <div class="admin-profile__container--posts">
      {posts?.length > 0 && posts.map((post) => <PostCard post={post} />)}
    </div>
  </section>
</RootLayout>

<style>
  .admin-profile {
    position: relative;
    width: 100%;
    margin: 0 auto;
    display: flex;
    flex-flow: column;
    padding-top: 48px;

    /* ENCABEZADO SUPERIOR */
    & > header {
      position: absolute;
      top: 0;
      z-index: 3;
      width: 100%;
      display: flex;
      flex-flow: row;
      padding: 6px 0;
      background-color: rgb(250, 250, 250);
      & > div {
        display: flex;
        flex-flow: column;
        margin-left: 6px;
      }
    }

    /* FOTO DE PORTADA */
    .admin-profile__header-photo {
      width: 100%;
      height: 220px;
      aspect-ratio: 16/9;
      border: 1px solid rgb(33, 33, 33);
    }
  }

  .admin-profile__container--bottom {
    position: relative;
    padding: 0 13px;
    /* AVATAR */
    .admin-profile__avatar {
      position: absolute;
      top: -70%;
      right: 13px;
      z-index: 1;
      max-width: 140px;
      width: 100%;
      aspect-ratio: 4/4;
      border: 5px solid #fff;
      border-radius: 100%;
      background-color: rgb(250, 250, 250);
    }

    /* USERNAME & NAME CONTAINER */
    .admin-profile__container--names {
      margin: 10px 0;
      & > h1 {
        font-weight: bold;
      }
      & > small {
        color: rgba(33, 33, 33, 0.7);
      }
    }

    /* BIOGRAFÍA */
    .admin-profile__bio {
      max-width: 46ch;
    }

    /* OTRA INFORMACIÓN */
    .admin-profile__container--other-info {
      margin: 10px 0;
      display: flex;
      flex-flow: row;
      gap: 10px;
      color: rgba(33, 33, 33, 0.6);
      & > span {
        width: fit-content;
        display: flex;
        flex-flow: row;
        align-items: center;
        justify-content: center;
        gap: 3px;
        font-size: 14px;
      }
    }

    /* SEGUIDORES Y SEGUIDOS */
    .admin-profile__container--followers {
      display: flex;
      flex-flow: row;
      align-items: center;
      justify-content: space-between;
      & > span > strong {
        color: #000;
      }
      & > span {
        color: rgba(33, 33, 33, 0.7);
      }

      /* BOTÓN EDITAR PERFIL */
      .admin-profile__edit-btn {
        width: fit-content;
        display: block;
        text-decoration: none;
        padding: 6px 16px;
        color: #000;
        background-color: var(--color_p);
        border-radius: 10px;
        transition:
          box-shadow 0.2s ease-in,
          transform 0.2s ease;

        &:hover {
          box-shadow: 0 3px 4px var(--color_shadow);
          transform: scale(1.02);
        }
        &:active {
          transform: scale(1);
        }
      }
    }
  }

  .admin-profile__container--posts {
    width: 100%;
    display: flex;
    flex-flow: column;
    flex: 1;
  }
</style>
